from typing import List

import requests

SOLR_DEFAULT_URL = 'http://localhost:8983/solr/'
CORENAME = "highlighter"

def _setupHighligtingRequest(query: str, text: str, frag_size: int, snippets: int = 8, lng: str = "GER", preTag : str = "<hl>", postTag: str = "</hl>",bsType = "SENTENCE") -> (
        str, dict):
    '''
        Takes care of the url and the data that need to be sent to the server

        Returns:
            url : str
            data : dict
    '''

    # URL setup
    baseURL = SOLR_DEFAULT_URL + CORENAME # SOLR_HIGHLIGHTER_CORE
    operation = "/highlight"

    data = {'q': query,
            'text': text,
            'hl.snippets': snippets,
            'hl.simple.pre': preTag,
            'hl.simple.post': postTag,
            'hl.fragsize': frag_size,
            'LNG': lng,
            'hl.bs.type' : bsType}  # Currently only "GER","ENG","DEF" supported -> changes the stemming used.

    return baseURL + operation, data


# Returns the response of the solr server
def _sendToSolrServer(url: str, data: dict) -> dict:
    '''
        Takes care of connecting to the solr server and parses the response to json

        Returns:
            json response of the solr server : dict
    '''

    # Connecting to the SolrService (assume that service has the right configuration)
    try:
        res = requests.post(url, data)
        res = res.json()
    except requests.exceptions.RequestException as e:
        raise Exception('Highglighting text failed. Check the solr server!')

    return res

def getOneHighlight(query: str, text: str, frag_size: int = 750, snippets: int = 1, pre_tag: str = '',
                    post_tag: str = '', lng: str = "ENG", bsType = "SENTENCE")->str:
    """
    Gets one highlight not indexing
    Returns:
        highight: str
    """
    url, data = _setupHighligtingRequest(query, text, frag_size, snippets, lng,pre_tag,post_tag,bsType=bsType)

    solrResponse = _sendToSolrServer(url, data)

    if not 'highlights' in solrResponse:
        return ""

    # Return text of first highlight
    return solrResponse['highlights'][0]['Text']

def getSmallHighlight(query: str, text: str, frag_size: int = 750, snippets: int = 1, pre_tag: str = '',
                    post_tag: str = '', lng: str = "ENG", allowedDeviation: int = 1)->str:
    """
        Gets one small highlight
        Try sentence if it is bigger than allowedDeviation * frag_size then take word passaging
        Returns:
            highight: str
        """

    sentenceHighlight = getOneHighlight(query, text, frag_size, snippets, pre_tag, post_tag, lng, "SENTENCE")
    if len(sentenceHighlight) > allowedDeviation * frag_size:
        return getOneHighlight(query, text, frag_size, snippets, pre_tag, post_tag, lng, "WORD")
    return sentenceHighlight


if __name__ == '__main__':

    text = """Register My Foods Add Custom Food My Recipes My Preferences My Tracking Sign Out Click here Passion fruit has more fiber per ounce than any other fresh fruit? On Nutrition Data, you'll find detailed nutrition information, plus unique analysis tools that tell you more about how foods affect your health and make it easier to choose healthy foods. 	"Search foods199 items found Creamy Peanut Butter Jif2 tbsp (32g)Nutrition Facts Calories 190Log food Peanut Butter – Natural Creamy Skippy2 tbsp (32g)Nutrition Facts Calories 190Log food Extra Crunchy Peanut Butter Jif2 tbsp (32g)Nutrition Facts Calories 190Log food Peanut Butter – Super Chunk Skippy Extra crunchy2 tbsp (32g)Nutrition Facts Calories 190Log food Creamy Peanut Butter – Reduced Fat Jif2 tbsp (36g)Nutrition Facts Calories 190Log food Natural Creamy Peanut Butter Smucker's2 tbsp (32g)Nutrition Facts Calories 200Log food Miniatures – Peanut Butter Cups Reese's5 miniatures (44g)Nutrition Facts Calories 220Log food Peanut Butter – Creamy – Organic Trader Joe's2 tbsp Nutrition Facts Calories 200Log food Peanut Butter Cup Reese's2 cups Nutrition Facts Calories 220Log food Creamy Peanut Butter Skippy2 tbsp (32g)Nutrition Facts Calories 190Log food Peanut Butter Crunchy Granola Bar Nature Valley2 bars Nutrition Facts Calories 190Log food Simply Creamy Peanut Butter Jif2 tbsp (31g)Nutrition Facts Calories 190Log food Peanut Butter – Creamy – Organic Arrowhead Mills2 tbsp Nutrition Facts Calories 190Log food Chewy Bar – Oats & Peanut Butter Fiber One1 bar (40g)Nutrition Facts Calories 140Log food Natural Chunky Peanut Butter Smucker's2 tbsp (32g)Nutrition Facts Calories 200Log food PB2 – Powered Peanut Butter Bell Plantation2 tbsp (12g)Nutrition Facts Calories 45Log food Peanut Butter Cookie Average all recipes1 cookie (3"" diameter)Nutrition Facts Calories 95Log food Creamy Peanut Butter Peter Pan2 tbsp (32g)Nutrition Facts Calories 210Log food Natural Peanut Butter – Super Chunk Skippy2 tbsp (32g)Nutrition Facts Calories 190Log food Chewy Granola Bar – Peanut Butter Chocolate Chip Quaker1 bar (24g)Nutrition Facts Calories 100Log food Peanut Butter – Creamy Smart Balance2 tbsp (32g)Nutrition Facts Calories 190Log food Sandwich Crackers – Toasty Crackers w/ Peanut Butter Austin1 package Nutrition Facts Calories 190Log food Peanut Butter – Reduced Fat Creamy Skippy2 tbsp (34g)Nutrition Facts Calories 180Log food Peanut Butter – Crunchy – Organic Trader Joe's2 tbsp Nutrition Facts Calories 200Log food Mojo Bar – Dark Chocolate Almond Coconut Clif1 bar (45g)Nutrition Facts Calories 200Log food Chewy Granola Bar – Peanut Peanut Butter Kashi1 bar (35g)Nutrition Facts Calories 140Log food Organic Peanut Butter – Creamy Mara Natha No stir2 tbsp (32g)Nutrition Facts Calories 190Log food Sandwich Crackers – Toasty Lance1 package (6 crackers)Nutrition Facts Calories 180Log food Peanut Butter – Dark Chocolate Dreams Peanut Butter & Co2 tbsp (32g)Nutrition Facts Calories 170Log food Clif Bar – Crunchy Peanut Butter Clif1 bar (68g)Nutrition Facts Calories 260Log food Protein Bar – Chocolate Peanut Butter Pure Protein1 bar (50g)Nutrition Facts Calories 190Log food Peanut Butter Filled Pretzels Trader Joe's11 pieces (30g)Nutrition Facts Calories 150Log food Peanut Butter Egg Reese's1 egg (34g)Nutrition Facts Calories 170Log food Creamy Peanut Butter Protein Bar think Thin1 bar Nutrition Facts Calories 230Log food Chocolate Peanut Butter Protein Meal Bar Special K1 bar (45g)Nutrition Facts Calories 180Log food Chewy Bar – Chocolate Peanut Butter Fiber One90 calorie1 bar (23g)Nutrition Facts Calories 90Log food Tagalongs Cookies Girl Scouts Peanut butter patties2 cookies (25g)Nutrition Facts Calories 140Log food Sandwich Crackers – Toastchee Lance1 package (6 crackers)Nutrition Facts Calories 220Log food Builder's Bar – Crunchy Peanut Butter Clif1 bar (68g)Nutrition Facts Calories 280Log food Chunky Peanut Butter Protein Bar think Thin1 bar Nutrition Facts Calories 240Log food Ritz Peanut Butter Cracker Sandwiches Nabisco1 package (39g)Nutrition Facts Calories 200Log food Peanut Butter Cookie Subway1 cookie (45g)Nutrition Facts Calories 220Log food Peanut Butter M&M's M&M's1 reg. pack (46.2g)Nutrition Facts Calories 240Log food Kids Sandwich – Peanut Butter & Jelly on Classic White Bread Panera Bread1 sandwich Nutrition Facts Calories 400Log food Nutrition Bar – Chocolate Peanut Butter Zone Perfect1 bar (50g)Nutrition Facts Calories 210Log food Sandwich Crackers – Cheese w/ Peanut Butter Austin1 package Nutrition Facts Calories 190Log food Dark Chocolate Peanut Butter Bar Atkins Harvest trail1 bar (38g)Nutrition Facts Calories 170Log food Uncrustables – Peanut Butter & Grape Jelly Smucker's1 sandwich (58g)Nutrition Facts Calories 210Log food Creamy Peanut Butter 365Organic2 tbsp (32g)Nutrition Facts Calories 200Log food Organic Peanut Butter – Creamy Kirkland2 tbsp (32g)Nutrition Facts Calories 200Log food Peanut Butter Patties Cookies Girl Scouts2 cookies (25g)Nutrition Facts Calories 130Log food Chocolate Peanut Butter Bar Atkins1 bar (60g)Nutrition Facts Calories 250Log food Do-si-dos Girl Scouts Peanut butter cremes3 cookies (34g)Nutrition Facts Calories 160Log food Sandwich Crackers – Cheese & Peanut Butter Keebler1 package (39g)Nutrition Facts Calories 190Log food Sandwich Crackers – Toast & Peanut Butter Keebler1 package (39g)Nutrition Facts Calories 190Log food Nutty Bars – Wafer w/ Peanut Butter Little Debbie Chocolate Covered1 serving Nutrition Facts Calories 312Log food Cookies – Peanut Butter Commercially Prep – Reg1 cookie Nutrition Facts Calories 71Log food Performance Energy Bar – Chocolate Peanut Butter Power Bar1 bar Nutrition Facts Calories 230Log food Peanut Butter Cups Trader Joe's3 cups Nutrition Facts Calories 180Log food Peanut Butter – Creamy Whole Foods All Natural2 tbsp Nutrition Facts Calories 200Log food Reese's Big Cup Reese's Peanut butter cup1 cup Nutrition Facts Calories 230Log food Peanut Butter – Unsweetened, Unsalted Kraft1 tbsp Nutrition Facts Calories 88Log food Crunchy Peanut Butter Peter Pan2 tbsp (32g)Nutrition Facts Calories 200Log food Uncrustables – Peanut Butter & Grape Jelly on Whole Wheat Bread Smucker's Reduced sugar1 sandwich (58g)Nutrition Facts Calories 190Log food Protein Plus Bar – Chocolate Peanut Butter Power Bar Reduced sugar1 bar (60g)Nutrition Facts Calories 200Log food Peanut Butter Cups Atkins2 cups (34g)Nutrition Facts Calories 160Log food Smooth Peanut Butter Laura Scudder's2 tbsp (32g)Nutrition Facts Calories 200Log food Peanut Butter Crunch Cereal Cap'n Crunch Milk not included3 ⁄ 4 cup (27g)Nutrition Facts Calories 110Log food Sandwich Crackers – Peanut Butter on Wheat Lance1 package (6 crackers)Nutrition Facts Calories 200Log food Ritz Bits – Peanut Butter Nabisco13 sandwiches (29g)Nutrition Facts Calories 140Log food Cereal Bar – High Protein – Peanut Butter South Beach Living1 bar (35g)Nutrition Facts Calories 140Log food Ice Cream – Chocolate Peanut Butter Haagen-Dazs0.5 cup (109g)Nutrition Facts Calories 330Log food Puffins Cereal – Peanut Butter Barbara's Bakery Milk not included3 ⁄ 4 cup (30 g)Nutrition Facts Calories 110Log food Chocolate Peanut Butter Bar Nutri System1 bar Nutrition Facts Calories 200Log food Peanut Butter Cookie Grandma's1 cookie (40.7g)Nutrition Facts Calories 190Log food Peanut Butter Cookie Otis Spunkmeyer1 cookie Nutrition Facts Calories 180Log food Sandwich Crackers – Peanut Butter & Honey on Captain's Wafers Lance1 package (6 crackers)Nutrition Facts Calories 190Log food Crunchy Peanut Butter – Reduced Fat Jif2 tbsp Nutrition Facts Calories 190Log food Ice Cream – Peanut Butter 'n Chocolate – 4 oz Baskin-Robbins1 scoop (4oz)Nutrition Facts Calories 320Log food Chocolate Peanut Butter Cup Ice Cream Edy's0.5 cup Nutrition Facts Calories 180Log food Peanut Butter Granola Bar Atkins1 bar (48g)Nutrition Facts Calories 210Log food Peanut Butter Cup Ice Cream Ben & Jerry's0.5 cup (114g)Nutrition Facts Calories 370Log food Cupcakes – Chocolate Peanut Butter Fresh Direct1 cupcake Nutrition Facts Calories 310Log food Peanut Butter – Organic – Freshly Ground Fresh Direct2 tbsp Nutrition Facts Calories 180Log food Peanut Butter & Honey – Creamy Jif2 tbsp (33g)Nutrition Facts Calories 180Log food Bar – Peanut Butter Cookie Luna1 bar Nutrition Facts Calories 180Log food Peanut Butter – Crunchy & Unsalted Trader Joe's2 tbsp Nutrition Facts Calories 190Log food Cookies – Peanut Butter on Nekot Lance1 package Nutrition Facts Calories 240Log food Creamy Peanut Butter – Whipped Peter Pan2 tbsp (24g)Nutrition Facts Calories 150Log food Peanut Butter Fudge Crisp Bar Atkins1 bar (35g)Nutrition Facts Calories 150Log food Creamy Peanut Butter Great Value2 tbsp (32g)Nutrition Facts Calories 180Log food Promises Peanut Butter & Milk Chocolate Dove5 pieces (39g)Nutrition Facts Calories 220Log food Chewy Dipps – Peanut Butter Quaker1 bar (30g)Nutrition Facts Calories 150Log food Blizzard – Reese's Peanut Butter Cup Dairy Queen1 small Nutrition Facts Calories 600Log food Cookie Dough – Peanut Butter Chocolate Chip Nestle Toll House pre-shaped cookies1 cookie Nutrition Facts Calories 80Log food Pretzel Nuggets – Peanut Butter 36510 pretzels Nutrition Facts Calories 140Log food Peanut Butter – Crunchy – Organic Whole Foods2 tbsp Nutrition Facts Calories 190Log food Peanut Butter – Smooth Operator Peanut Butter & Co2 tbsp (32g)Nutrition Facts Calories 180Log food Peanut Butter Granola Bar Nutri System1 bar Nutrition Facts Calories 160Log food Reese's – Peanut Butter Tree Reese's1 piece Nutrition Facts Calories 170Log food Uncrustables – Peanut Butter & Strawberry Jam Smucker's1 sandwich (58g)Nutrition Facts Calories 210Log food Peanut Butter – Roasted Honey Nut Creamy Skippy2 tbsp (32g)Nutrition Facts Calories 200Log food Reese's Klondike Bar Klondike1 bar (4 fl oz)Nutrition Facts Calories 250Log food Kids Meals – Peanut Butter & Jelly on White Bread Crispers Does not include side items1 serving Nutrition Facts Calories 320Log food Peanut Butter Cup Ice Cream Breyers0.5 cup Nutrition Facts Calories 160Log food Crunch Bar – Peanut Butter Medifast1 bar (32g)Nutrition Facts Calories 110Log food Peanut Butter – Creamy & Salted Trader Joe's2 tbsp (32g)Nutrition Facts Calories 190Log food Nutty Peanut Butter Laura Scudder's2 tbsp (32g)Nutrition Facts Calories 180Log food Peanut Butter – Creamy – Natural Kroger2 tbsp Nutrition Facts Calories 190Log food Reese's – Peanut Butter Lovers Cups Reese's2 cups Nutrition Facts Calories 210Log food Chocolate Peanut Butter Pie Denny's1 slice Nutrition Facts Calories 653Log food Ice Cream – Chocolate Peanut Butter Cup Turkey Hill0.5 cup (66g)Nutrition Facts Calories 180Log food Lindor Truffles – Peanut Butter Lindt3 balls Nutrition Facts Calories 210Log food Peanut Butter – Smoothw/ Salt2 tbsp Nutrition Facts Calories 190Log food Butter Toffee Peanuts Good Sense1 ⁄ 4 cup (35g)Nutrition Facts Calories 170Log food Cookie – Peanut Butter Chocolate Chip Erbert & Gerbert's1 cookie Nutrition Facts Calories 200Log food Reese's – Peanut Butter Cups – Sugar Free Reese's5 pieces (44g)Nutrition Facts Calories 180Log food Peanut Butter Granola Nature's Path0.5 cup (55g)Nutrition Facts Calories 260Log food Peanut Butter – Creamy & Unsalted Trader Joe's2 tbsp (32g)Nutrition Facts Calories 190Log food Peanut Butter – Crunchy Kroger2 tbsp Nutrition Facts Calories 190Log food Breakfast Square – Peanut Butter Quaker1 bar (60g)Nutrition Facts Calories 250Log food Anytime Bar – Chocolatey Peanut Butter Jenny Craig1 bar (33g)Nutrition Facts Calories 110Log food Organic Creamy Peanut Butter Smucker's2 tbsp (32g)Nutrition Facts Calories 210Log food Crunchy Peanut Butter 3652 tbsp (32g)Nutrition Facts Calories 200Log food Protein Plate w/ Peanut Butter Starbucks1 plate (187g)Nutrition Facts Calories 370Log food Peanut Butter – Chunkyw/ Salt2 tbsp Nutrition Facts Calories 188Log food Peanut Butter – Crunchy – Organic Arrowhead Mills2 tbsp Nutrition Facts Calories 190Log food Dark Chocolate Peanut Butter Cups Newman's Own Organic1 package (34g)Nutrition Facts Calories 180Log food Organic Peanut Butter – Creamy & Roasted Mara Nathaw/ Salt2 tbsp (32g)Nutrition Facts Calories 190Log food Peanut Butter – Honey-Roasted – Freshly Ground Fresh Direct2 tbsp Nutrition Facts Calories 179Log food Family Bar – Peanut Butter Chocolate Nu Go1 bar (50g)Nutrition Facts Calories 170Log food Pie – Peanut Butter Creme Sara Lee Individual serving1 dessert Nutrition Facts Calories 360Log food Chocolate Peanut Butter Maltballs Trader Joe's4 pieces Nutrition Facts Calories 210Log food Peanut Butter – Crunchy & Salted Trader Joe's2 tbsp (32g)Nutrition Facts Calories 190Log food Peanut Butter 365All Natural2 tbsp Nutrition Facts Calories 200Log food Protein Snack Bar – Chocolate Peanut Butter Crisp Power Bar1 bar Nutrition Facts Calories 220Log food Peanut Butter – Reduced Fat Super Chunk Skippy2 tbsp (34g)Nutrition Facts Calories 180Log food Smoothie – Peanut Butter Banana World Wrapps16 oz Nutrition Facts Calories 502Log food Chewy Granola Bar – Peanut Butter Chocolate Chip Quaker25% less sugar1 bar (24g)Nutrition Facts Calories 100Log food Frozen Yogurt – Soft Serve – Peanut Butter TCBY0.5 cup (95g)Nutrition Facts Calories 130Log food Nutrition Bar – Peanut Butter Tiger's Milk1 bar Nutrition Facts Calories 150Log food Peanut Butter Filled Pretzels – No Salt Trader Joe's11 pieces (30g)Nutrition Facts Calories 150Log food Plant Protein Bar – Dark Chocolate Peanut Butter Power Bar1 bar Nutrition Facts Calories 230Log food Balance Bar – Peanut Butter Balance1 bar (50g)Nutrition Facts Calories 200Log food Oreo – Double Stuf – Peanut Butter Creme Nabisco2 cookies Nutrition Facts Calories 140Log food Monster w/ Peanut Butter Cookie Starbucks1 cookie Nutrition Facts Calories 450Log food Organic Peanut Butter – Crunchy Mara Natha No stir2 tbsp (32g)Nutrition Facts Calories 190Log food Organic Chunky Peanut Butter Smucker's2 tbsp (32g)Nutrition Facts Calories 210Log food Peanut Butter – Chunky Smart Balance2 tbsp (32g)Nutrition Facts Calories 190Log food Baking Pieces – Reese's Peanut Butter Chips Reese's1 tbsp (15g)Nutrition Facts Calories 80Log food Smooth Unsalted Peanut Butter Laura Scudder's2 tbsp (32g)Nutrition Facts Calories 180Log food Ice Cream – Slow Churned Peanut Butter Cookie Dough Edy's0.5 cup Nutrition Facts Calories 120Log food Crackers – Sandwich-type w/ Peanut Butter Filling6 crackers Nutrition Facts Calories 192Log food Detour Bar – Peanut Butter Designer Protein1 bar (43g)Nutrition Facts Calories 160Log food Peanut Butter Moo'd Smoothie – 16 oz. size Jamba Juice Good Moo'd1 serving Nutrition Facts Calories 530Log food ZBar Protein – Peanut Butter Clif1 bar (36g)Nutrition Facts Calories 140Log food Anytime Bar – Peanut Butter Chocolate Crunch Jenny Craig1 bar (30g)Nutrition Facts Calories 110Log food Sandwich Crackers – Malt Lance1 package (6 crackers)Nutrition Facts Calories 190Log food Peanut Butter Cookie Mix Betty Crocker Prepared2 cookies Nutrition Facts Calories 140Log food Dessert – Chocolate & Peanut Butter Swirl – Mini Seasons 521 order Nutrition Facts Calories 293Log food Peanut Butter Cookie Nutri System1 cookie Nutrition Facts Calories 140Log food Granola Bar – Crunchy Peanut Butter Trader Joe's2 bars Nutrition Facts Calories 190Log food Mojo Bar – Peanut Butter Pretzel Clif1 bar (45g)Nutrition Facts Calories 190Log food Peanut Butter – Smooth – Organic Whole Foods2 tbsp Nutrition Facts Calories 190Log food Brownie Bar – Peanut Butter1 serving Nutrition Facts Calories 450Log food Candy – Reese's Peanut Butter Cup Cold Stone Creamery1 piece Nutrition Facts Calories 190Log food Peanut Butter – Crunch Time Peanut Butter & Co2 tbsp (32g)Nutrition Facts Calories 180Log food Peanut Butter – Freshly Ground Fresh Direct2 tbsp Nutrition Facts Calories 180Log food Peanut Butter Cups – Mini – Milk Chocolate Trader Joe's27 pieces Nutrition Facts Calories 210Log food Mini Sandwich Crackers – Peanut Butter Trader Joe's12 crackers Nutrition Facts Calories 150Log food Chewy Bar – High Fiber – Oats & Peanut Butter Great Value1 bar (40g)Nutrition Facts Calories 150Log food Chocolate Peanut Butter Pretzel Bar Atkins1 bar (48g)Nutrition Facts Calories 210Log food Ice Cream – Peanut Butter Party Blue Bunny0.5 cup (77g)Nutrition Facts Calories 220Log food Pie – Reese's Peanut Butter Cup Bob Evans1 slice Nutrition Facts Calories 597Log food Sandwich – Peanut Butter & Jelly on French Bread Atlanta Bread1 sandwich Nutrition Facts Calories 600Log food Ice Cream – Slow Churned Peanut Butter Cup Edy's0.5 cup Nutrition Facts Calories 130Log food Cookie – Peanut Butter Chocolate Chip The Protein Bakery1 cookie Nutrition Facts Calories 140Log food Ice Cream Sundae – Reese's Peanut Butter Cup Friendly's1 sundae Nutrition Facts Calories 890Log food Chips Ahoy! 
    """
    qWord = "nutrition facts database"

    text = "R. Martin, and its television adaptation Game of Thrones. Introduced in 1996's A Game of Thrones, Bran is the second son and fourth child of Eddard Stark, the honorable lord of Winterfell, an ancient fortress in the North of the fictional kingdom of Westeros. "
    qWord = "brian game of thrones"

    print(len(getOneHighlight(qWord, text)))
    print(len(getOneHighlight(qWord, text,bsType="WORD")))
    print(len(getOneHighlight(qWord, text, bsType="CHARACTER")))
    
    print(getSmallHighlight(qWord,text))